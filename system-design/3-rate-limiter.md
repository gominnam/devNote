## 처리율 제한장치 (Rate Limiter)


### 1. Rate Limiter ?

- Rate Limiter (처리율 제한장치)
: 1. Rate Limiter는 **특정 시간 동안의 요청 수를 제한**하는 기능을 말한다. 
: 2. **서버 부하를 줄이고, 서비스의 가용성을 높일 수 있다.**
: 3. **DDoS 공격**을 방지할 수 있다.
: 4. **API 요청**을 제한하는 등 다양한 용도로 사용된다.
</br></br>


### 2. Rate Limiter 설계

- 요청 수 제한이 넘을 경우
: 1. **HTTP 429 Too Many Requests** 응답을 반환한다.
: 2. **Retry-After** 헤더를 사용하여 클라이언트에게 다음 요청을 보낼 때까지 기다리라고 알려준다.
: 3. **Retry-After** 헤더는 **초 단위**로 지정한다.

- Client 측에 설계
: 클라이언트 요청은 쉽게 위변조가 가능해 안정적인 제한을 위한 좋은 방법이 아니다.

- Server 측에 설계
: 위변조가 어려우므로 신뢰할 수 있다. 
: 서버측에서 모니터링하고 로깅할 수 있어, 문제 발생 시 대응이 용이하다. 

- Middleware 측에 설계
: API Gateway, Load Balancer, Reverse Proxy 등에서 사용된다.
</br></br>


### 3. Rate Limiter Algorithm 

- **Token Bucket Algorithm** (토큰 버킷 알고리즘)
: 토른 버킷은 지정된 `용량`을 갖는 컨테이너이다.
: 토큰 버킷은 **토큰**을 **고정된 속도**로 생성한다.
: **요청**이 들어오면 **토큰**을 **소비**한다.
: **토큰**이 **부족**하면 **요청을 거부**(버림)한다.
: 인자 2개를 사용한다.

  - **용량** (Capacity): 버킷의 최대 토큰 수
  - **토큰공급률** (Rate): 토큰 생성 속도


- **Leaky Bucket Algorithm** (누수 버킷 알고리즘)
: 보통 FIFO 큐로 구현된다.
: **요청**이 들어오면 **큐**에 **추가**한다.
: **큐**가 **가득 차면** **요청을 거부**(버림)한다.
: 지정된 시간마다 **큐**에서 **요청을 꺼내** 처리한다.
: 인자 2개를 사용한다.

  - **용량** (Capacity): 버킷의 최대 요청 수
  - **처리율** (Rate): 요청 처리 속도

</br></br>

### 4. Basic Architecture

- 요청을 세서 기준 한도를 넘어서면 요청을 거부 (Counting 기준)
: IP 주소
: API Endpoint
: User

- Counter 보통 **Redis**를 사용한다.
: 메모리 기반 저장장치로 속도가 빠르고 **캐시**로 사용하기 좋다.
: 명령어

  - **INCR** : 카운터 증가
  - **EXPIRE** : 만료 시간 설정


### 5. 분산 환경 Rate Limiter

- Question : 여러 대의 서버와 병렬 스레드를 지원하도록 시스템 확장
: 경쟁 조건
: 동기화

- Answer
: 1. 락(Lock)을 사용하여 해결 할 수 있지만 성능이 상당히 떨어진다.
: 2. Redis의 RuaScript를 사용
  : - **Atomic**한 연산을 수행한다.
  : - Transaction 처럼 작동
: 3. Redis의 Sorted Set을 사용하여 해결 할 수 있다.
  : - **Score**를 사용하여 **현재 시간**을 기록한다.
  : - **Score**를 사용하여 **요청 수**를 기록한다.
  : - **Score**를 사용하여 **요청 수**를 **초과**하면 **요청을 거부**한다.  
  :   ex) user_id를 키로 사용하고, 요청 시간을 score로 사용 하여 Sorted Set에 저장한다.
 


 
